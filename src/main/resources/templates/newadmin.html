<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"
          integrity="sha256-o4MgtZRjyHqsKdwUIhHL/zdU8fNl5QzNwT1x0QVGeyk="
          crossorigin="anonymous"></script>
</head>
<body>

<div class="container mt-4">
  <table class="table table-striped" id="userTable">
    <thead>
    <tr>
      <th>ID</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Age</th>
      <th>Email</th>
      <th>Role</th>
      <th>Edit</th>
      <th>Delete</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Form for editing user goes here -->
        <form id="editForm">
          <!-- Input fields for user data -->
          <input type="hidden" id="editUserId" name="id" />
          <label for="editFirstName">First Name</label>
          <input type="text" class="form-control" id="editFirstName" name="firstname" required />
          <!-- Add other input fields as needed -->
          <button type="submit" class="btn btn-primary mt-3">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Form for deleting user goes here -->
        <form id="deleteForm">
          <!-- Display user information -->
          <p>Are you sure you want to delete this user?</p>
          <input type="hidden" id="deleteUserId" name="id" />
          <button type="submit" class="btn btn-danger">Delete User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Function to fetch and update user table
  function updateUserTable() {
    fetch('/api/admin')
            .then(response => response.json())
            .then(users => {
              const tbody = $('#userTable tbody');
              tbody.empty();

              users.forEach(user => {
                tbody.append(`
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.firstname}</td>
                            <td>${user.lastname}</td>
                            <td>${user.age}</td>
                            <td>${user.email}</td>
                            <td>${user.roleToString()}</td>
                            <td><button class="btn btn-info btn-edit" data-bs-toggle="modal" data-bs-target="#editModal" data-user='${JSON.stringify(user)}'>Edit</button></td>
                            <td><button class="btn btn-danger btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal" data-user='${JSON.stringify(user)}'>Delete</button></td>
                        </tr>
                    `);
              });
            })
            .catch(error => console.error('Error fetching user data:', error));
  }

  // Event listener for editing user button
  $('#userTable').on('click', '.btn-edit', function () {
    const userData = JSON.parse($(this).data('user'));

    // Populate edit modal with user data
    $('#editUserId').val(userData.id);
    $('#editFirstName').val(userData.firstname);
    // Add logic to populate other fields as needed

    // Show the edit modal
    $('#editModal').modal('show');
  });

  // Event listener for deleting user button
  $('#userTable').on('click', '.btn-delete', function () {
    const userData = JSON.parse($(this).data('user'));

    // Populate delete modal with user data
    $('#deleteUserId').val(userData.id);

    // Show the delete modal
    $('#deleteModal').modal('show');
  });

  // Event listener for form submission in edit modal
  $('#editForm').submit(function (event) {
    event.preventDefault();

    const formData = new FormData(this);

    // Fetch API to update user data on the server
    fetch('/api/admin/' + formData.get('id'), {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(Object.fromEntries(formData)),
    })
            .then(response => {
              if (response.ok) {
                // Update the user table after successful update
                updateUserTable();
              } else {
                console.error('Error updating user data:', response.statusText);
              }
            })
            .catch(error => console.error('Error updating user data:', error))
            .finally(() => $('#editModal').modal('hide'));
  });

  // Event listener for form submission in delete modal
  $('#deleteForm').submit(function (event) {
    event.preventDefault();

    const formData = new FormData(this);

    // Fetch API to delete user data on the server
    fetch('/api/admin/' + formData.get('id'), {
      method: 'DELETE',
    })
            .then(response => {
              if (response.ok) {
                // Update the user table after successful deletion
                updateUserTable();
              } else {
                console.error('Error deleting user data:', response.statusText);
              }
            })
            .catch(error => console.error('Error deleting user data:', error))
            .finally(() => $('#deleteModal').modal('hide'));
  });

  // Initial load of user table
  updateUserTable();
</script>
</body>
</html>
